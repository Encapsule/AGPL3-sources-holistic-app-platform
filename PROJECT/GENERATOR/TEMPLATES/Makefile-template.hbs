# THIS FILE IS CODE-GENERATED
# {{author}} {{name}} v{{version}} "{{codename}}" {{buildID}} {{buildSource}}

# https://www.gnu.org/software/make/manual/make.html
# https://timmurphy.org/2015/09/27/how-to-get-a-makefile-directory-path/
# https://stackoverflow.com/questions/33126425/how-to-remove-the-last-trailing-backslash-in-gnu-make-file
# $(patsubst %\,%,$(__PATHS_FEATURE))

DIR_ROOT=$(patsubst %/,%,$(dir $(realpath $(firstword $(MAKEFILE_LIST)))))
$(info ***** Encapsule/holistic application Makefile *****)
$(info DIR_ROOT is $(DIR_ROOT))

DIR_MODULES=$(DIR_ROOT)/node_modules
DIR_TOOLBIN=$(DIR_MODULES)/.bin

DIR_PROJECT=$(DIR_ROOT)/PROJECT
DIR_PROJECT_BUILD=$(DIR_PROJECT)/BUILD
DIR_PROJECT_TEST=$(DIR_PROJECT)/TEST
DIR_PROJECT_DEPLOY=$(DIR_PROJECT)/DEPLOY

TOOL_GEN_REPO_BUILDTAG=$(DIR_PROJECT)/generate-package-build-manifest.js

TOOL_ESLINT=$(DIR_TOOLBIN)/eslint
TOOL_BABEL=$(DIR_TOOLBIN)/babel
TOOL_WEBPACK=$(DIR_TOOLBIN)/webpack-cli
TOOL_WEBPACK_FLAGS=--display-modules --verbose --debug --progress --colors --devtool source-map --output-pathinfo

DIR_SOURCES=$(DIR_ROOT)/SOURCES
DIR_SOURCES_ASSETS=$(DIR_SOURCES)/ASSETS
DIR_SOURCES_CLIENT=$(DIR_SOURCES)/CLIENT
DIR_SOURCES_COMMON=$(DIR_SOURCES)/COMMON
DIR_SOURCES_SERVER=$(DIR_SOURCES)/SERVER

DIR_BUILD=$(DIR_ROOT)/BUILD
DIR_BUILD_PHASE1=$(DIR_BUILD)/transpile-phase1
DIR_BUILD_PHASE2=$(DIR_BUILD)/webpack-phase2
DIR_BUILD_PHASE3=$(DIR_BUILD)/runtime-phase3

DIR_DISTS=$(DIR_ROOT)/DISTS

default:
	@echo ================================================================
	@echo Please specify Makefile target\(s\) to evaluate as arguments to \'make\'.
	@echo Type \'make\' and use shell auto-complete to enumerate Makefile targets.
	@echo ================================================================

# ================================================================
# Build environment
#

configure:
	@echo Configuring build environment...
	yarn install --verbose
	@echo Build environment has been configured.

clean:
	@echo Cleaning up the output of the last application build...
	rm -rf $(DIR_BUILD)
	@echo The BUILD directory and its contents has been removed.

scrub: clean
	@echo Scrubbing the local build environment...
	@echo ... removing previously-installed package dependencies.
	rm -rf $(DIR_MODULES)
	@echo Dependencies will be re-installed from package cache on next 'make configure'.

reset: scrub
	@echo Local build environment reset...
	yarn cache clean
	@echo Dependencies will be re-installed from refreshed package cache \(requires Internet\) on next 'make configure'.

application: configure

#	For now, this recipe is addative; resource rename and delete in source input directories
#	will not automatically clean the BUILD directory tree. In this case execute `make clean`.

#	PHASE0 - create a copy of the SOURCES directory structure.
	mkdir -p $(DIR_BUILD_PHASE1)
	cp -rv $(DIR_SOURCES)/* $(DIR_BUILD_PHASE1)

#	PHASE1 - transpile modules from SOURCES into PHASE1 directory overwriting PHASE0 clone copies.
	$(TOOL_BABEL) --config-file $(DIR_ROOT)/.babelrc --out-dir $(DIR_BUILD_PHASE1) --keep-file-extension --verbose $(DIR_SOURCES)

#	PHASE2 - create application server and client bundles via webpack.
#	https://stackoverflow.com/questions/25956937/how-to-build-minified-and-uncompressed-bundle-with-webpack
	$(TOOL_WEBPACK) $(TOOL_WEBPACK_FLAGS) --config $(DIR_PROJECT_BUILD)/webpack.config.app.server.js
	$(TOOL_WEBPACK) $(TOOL_WEBPACK_FLAGS) --config $(DIR_PROJECT_BUILD)/webpack.config.app.client.js

#	PHASE3 - create application image
	mkdir -p $(DIR_BUILD_PHASE3)
	cp -r $(DIR_BUILD_PHASE2)/* $(DIR_BUILD_PHASE3)/
	cp -r $(DIR_SOURCES_ASSETS)	$(DIR_BUILD_PHASE3)/

# ----------------------------------------------------------------

# THIS ISN'T HOOKED UP YET.

env_tag_build:
	@echo Generating application build manifest...
	$(TOOL_GEN_REPO_BUILDTAG) > $(DIR_BUILD)/holistic.json
	@echo Application build manifest generated.

